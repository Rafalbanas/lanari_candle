<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Lanari Admin</title>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f4f4f9; }
    h1, h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    input, select, button { padding: 8px; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    .btn { cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
    .btn:hover { background: #0056b3; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #a71d2a; }
    .status-NEW { color: blue; }
    .status-PAID { color: green; font-weight: bold; }
    .status-SHIPPED { color: purple; }
    .status-CANCELED { color: red; text-decoration: line-through; }
  </style>
</head>
<body>
  <h1>Lanari Admin Panel</h1>

  <section id="authSection">
    <h2>Logowanie</h2>
    <input id="email" placeholder="Email admina">
    <input id="password" type="password" placeholder="Hasło">
    <button class="btn" onclick="login()">Zaloguj</button>
  </section>

  <div id="dashboard" style="display:none;">
    <section>
      <h2>Produkty</h2>
      <div style="display:flex; gap:10px;">
        <input id="newProdName" placeholder="Nazwa">
        <input id="newProdPrice" placeholder="Cena (grosze)" type="number">
        <input id="newProdImage" placeholder="URL miniatury (opcjonalnie)" style="min-width:180px;">
        <button class="btn" onclick="createProduct()">Dodaj Produkt</button>
      </div>
      <button class="btn" onclick="loadProducts()">Odśwież listę</button>
      <table id="productsTable">
        <thead><tr><th>ID</th><th>Nazwa</th><th>Cena (PLN)</th><th>Aktywny</th><th>Akcje</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Zamówienia</h2>
      <button class="btn" onclick="loadOrders()">Odśwież listę</button>
      <table id="ordersTable">
        <thead><tr><th>ID</th><th>Data</th><th>Klient</th><th>Total (PLN)</th><th>Status</th><th>Pozycje</th><th>Akcje</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section>
      <h2>Galeria (upload)</h2>
      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
        <input type="file" id="galleryFile" accept="image/*">
        <input id="galleryCaption" placeholder="Podpis (opcjonalnie)">
        <button class="btn" onclick="uploadMedia()">Wyślij</button>
        <button class="btn" onclick="loadGallery()">Odśwież listę</button>
      </div>
      <div id="galleryStatus" style="color:#555; margin-top:6px;"></div>
      <div id="galleryGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:10px; margin-top:12px;"></div>
    </section>
  </div>

<script>
const API = "/admin/api"; // Proxy w main.py lub bezpośrednio
let token = localStorage.getItem("admin_token");
const STATIC_BASE = ""; // ten sam host

if (token) showDashboard();

async function api(path, method="GET", body=null) {
  const opts = {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    }
  };
  if (body) opts.body = JSON.stringify(body);
  
  const res = await fetch(path, opts);
  if (res.status === 401) {
    alert("Sesja wygasła");
    logout();
    return null;
  }
  if (!res.ok) {
    const err = await res.json().catch(() => ({detail: res.statusText}));
    alert("Błąd: " + JSON.stringify(err.detail));
    return null;
  }
  return res.json();
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  
  // Używamy publicznego endpointu auth
  const res = await fetch("/api/auth/login", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({email, password})
  });
  
  if (res.ok) {
    const data = await res.json();
    token = data.access_token;
    localStorage.setItem("admin_token", token);
    showDashboard();
  } else {
    alert("Błąd logowania");
  }
}

function logout() {
  localStorage.removeItem("admin_token");
  location.reload();
}

function showDashboard() {
  document.getElementById("authSection").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  loadProducts();
  loadOrders();
}

async function loadProducts() {
  const products = await api(API + "/products");
  if (!products) return;
  
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = products.map(p => `
    <tr>
      <td>${p.id}</td>
      <td>${p.name}<br>${p.image_url ? `<img src="${p.image_url.startsWith('http') ? p.image_url : (STATIC_BASE + p.image_url)}" style="max-width:70px;max-height:70px;object-fit:cover;border:1px solid #ddd;border-radius:4px;margin-top:4px;">` : '<span style="color:#888;font-size:12px;">brak miniatury</span>'}</td>
      <td>${(p.price_pln / 100).toFixed(2)}</td>
      <td>${p.is_active ? "TAK" : "NIE"}</td>
      <td>
        <button class="btn btn-danger" onclick="deleteProduct(${p.id})">Usuń</button>
        <div style="margin-top:6px;">
          <input type="file" id="img-${p.id}" accept="image/*" style="display:none" onchange="uploadProductImage(${p.id})">
          <button class="btn" onclick="document.getElementById('img-${p.id}').click()">Miniatura</button>
          <button class="btn" onclick="promptImageUrl(${p.id})" style="margin-top:4px;">URL</button>
        </div>
      </td>
    </tr>
  `).join("");
}

async function createProduct() {
  const name = document.getElementById("newProdName").value;
  const price = document.getElementById("newProdPrice").value;
  const image_url = document.getElementById("newProdImage").value || null;
  if (!name || !price) return alert("Podaj nazwę i cenę");
  
  await api(API + "/products", "POST", {
    name, 
    price_pln: parseInt(price),
    is_active: true,
    image_url,
  });
  loadProducts();
}

async function uploadProductImage(id) {
  const input = document.getElementById(`img-${id}`);
  if (!input || !input.files.length) return;
  const file = input.files[0];
  const fd = new FormData();
  fd.append("file", file);
  fd.append("caption", `thumb:${id}`);
  fd.append("is_public", "false");

  // Najpierw upload do /api/media
  const uploadRes = await fetch("/api/media", {
    method: "POST",
    body: fd,
    headers: token ? { "Authorization": `Bearer ${token}` } : {},
    credentials: "include",
  });
  if (!uploadRes.ok) {
    alert("Upload nieudany");
    return;
  }
  const media = await uploadRes.json();
  const url = media.url;

  // Patch produktu z image_url
  await api(API + `/products/${id}`, "PATCH", { image_url: url });
  loadProducts();
}

async function promptImageUrl(id) {
  const url = prompt("Wklej URL miniatury (np. /static/uploads/...)");
  if (!url) return;
  await api(API + `/products/${id}`, "PATCH", { image_url: url });
  loadProducts();
}

async function deleteProduct(id) {
  if(!confirm("Na pewno usunąć?")) return;
  await api(API + `/products/${id}`, "DELETE");
  loadProducts();
}

const STATUS_OPTIONS = ["NEW", "IN_PREPARATION", "PAID", "SHIPPED", "CANCELED"];

async function loadOrders() {
  const orders = await api(API + "/orders");
  if (!orders) return;
  
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = orders.map(o => {
    const itemsText = (o.items || []).map(i => `${i.name} ×${i.qty} (${(i.unit_price_pln/100).toFixed(2)} PLN)`).join('<br>');
    const json = JSON.stringify(o).replace(/"/g, '&quot;');
    const options = STATUS_OPTIONS.map(s => `<option value="${s}" ${s === o.status ? "selected" : ""}>${s}</option>`).join("");
    return `
      <tr>
        <td>${o.id}</td>
        <td>${new Date(o.created_at).toLocaleString()}</td>
        <td>${o.email}</td>
        <td>${(o.total_pln / 100).toFixed(2)}</td>
        <td class="status-${o.status}">
          <select id="status-${o.id}">
            ${options}
          </select>
        </td>
        <td>${itemsText || '(brak pozycji)'}</td>
        <td>
          <button class="btn" onclick="alert('Szczegóły w JSON: ' + JSON.stringify(${json}))">Info</button>
          <button class="btn" onclick="updateOrderStatus(${o.id})">Zapisz status</button>
        </td>
      </tr>
    `;
  }).join("");
}

async function updateOrderStatus(id) {
  const select = document.getElementById(`status-${id}`);
  if (!select) return;
  const status = select.value;
  const res = await api(API + `/orders/${id}/status`, "PATCH", { status });
  if (res) {
    alert("Status zaktualizowany");
    loadOrders();
  }
}

// === GALERIA ===
async function loadGallery() {
  const statusEl = document.getElementById("galleryStatus");
  statusEl.textContent = "Ładowanie...";
  try {
    const res = await fetch("/api/media?include_hidden=true", { headers: token ? { "Authorization": `Bearer ${token}` } : {} });
    if (!res.ok) throw new Error("Błąd pobierania");
    const items = await res.json();
    renderGallery(items);
    statusEl.textContent = `Załadowano ${items.length} zdjęć.`;
  } catch (e) {
    statusEl.textContent = e.message;
  }
}

function renderGallery(items) {
  const grid = document.getElementById("galleryGrid");
  if (!items || !items.length) {
    grid.innerHTML = '<div style="grid-column:1/-1; color:#666;">Brak zdjęć.</div>';
    return;
  }
  grid.innerHTML = items.map(it => {
    const src = it.url.startsWith("http") ? it.url : (STATIC_BASE + it.url);
    return `<div style="border:1px solid #ddd; border-radius:6px; overflow:hidden; background:#fff; position:relative;">
      <button onclick="deleteMedia(${it.id})" style="position:absolute; top:6px; right:6px; border:none; background:#dc3545; color:#fff; padding:4px 6px; border-radius:4px; cursor:pointer;">×</button>
      <img src="${src}" alt="${it.caption || ""}" style="width:100%; display:block; aspect-ratio:1/1; object-fit:cover;">
      <div style="padding:6px; font-size:12px; color:#444;">${it.caption || "(bez opisu)"}<br><span style="color:#888;">${new Date(it.created_at).toLocaleString()}</span></div>
    </div>`;
  }).join("");
}

async function uploadMedia() {
  const fileInput = document.getElementById("galleryFile");
  const captionInput = document.getElementById("galleryCaption");
  const statusEl = document.getElementById("galleryStatus");

  const file = fileInput.files[0];
  if (!file) {
    statusEl.textContent = "Wybierz plik.";
    return;
  }

  const fd = new FormData();
  fd.append("file", file);
  fd.append("caption", captionInput.value);
  fd.append("is_public", "true");

  statusEl.textContent = "Wysyłanie...";
  try {
    const res = await fetch("/api/media", {
      method: "POST",
      body: fd,
      headers: token ? { "Authorization": `Bearer ${token}` } : {},
      credentials: "include",
    });
    if (!res.ok) {
      const msg = await res.text().catch(() => res.statusText);
      throw new Error(`Upload failed (${res.status}): ${msg}`);
    }
    statusEl.textContent = "Dodano.";
    fileInput.value = "";
    captionInput.value = "";
    await loadGallery();
  } catch (e) {
    statusEl.textContent = e.message;
    console.error("upload error", e);
  }
}

async function deleteMedia(id) {
  if (!confirm("Usunąć to zdjęcie?")) return;
  const statusEl = document.getElementById("galleryStatus");
  statusEl.textContent = "Usuwanie...";
  try {
    const res = await fetch(`/api/media/${id}`, {
      method: "DELETE",
      headers: token ? { "Authorization": `Bearer ${token}` } : {},
    });
    if (!res.ok) {
      const msg = await res.text().catch(() => res.statusText);
      throw new Error(msg || "Błąd usuwania");
    }
    statusEl.textContent = "Usunięto.";
    await loadGallery();
  } catch (e) {
    statusEl.textContent = e.message;
  }
}
</script>
</body>
</html>
